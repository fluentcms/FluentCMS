@page "/admin/sites/update/{Id:guid}"
@page "/admin/sites/create"
@using FluentCMS.Entities
@inject HttpClient _httpClient
@inject NavigationManager _navigationManager

<EditPage Title="Site Update" Model="Site" OnValidSubmit="ValidSubmit">
    <Content>

    <FormInput Label="Name" @bind-Value="Site.Name" Name="name"/>
    <FormTextarea Rows="3" Label="Description" @bind-Value="Site.Description" Name="description"/>
    
    <FormField Label="Role">
        @* TODO *@
    </FormField>
    <FormInput Label="Urls (Comma Separated Urls)" Required @bind-Value="Urls" Name="url" />

    </Content>

    <FooterActions>
        <Button Type="submit" Color="primary">Save</Button>
    </FooterActions>
</EditPage>

@code {
    [Parameter]
    public Guid? Id { get; set; }
    public Entities.Site Site { get; set; } = new Site() { Name = "Site name" };

    public string Urls
    {
        get { return string.Join(", ", Site?.Urls); }
        set { Site.Urls = value.Split(['\n', ',']).Select(x => x.Trim()).ToList(); }
    }

    public List<dynamic> Roles { get; set; } = new()
    {
        { new { Id = Guid.Parse("AA0DBDB8-008B-4A8A-8272-47E200BB0A20"), Name = "Admin" } },
        { new { Id = Guid.Parse("AA0DBDB8-008B-4A8A-8272-47E200BB0A21"), Name = "Admin2" } },
    };
    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        if (Id == null)
        {
            return;
        }
        try
        {
            var response = (await _httpClient.GetFromJsonAsync<ApiResult<Site>>($"site/getById/{Id.Value}"))!;
            if (response != null)
            {
                Site = response.Data!;
            }
        }
        catch (Exception)
        {

            throw;
        }

    }
    public async Task ValidSubmit()
    {
        //Create
        if (Id == null)
        {
            var createCommand = new SiteCreateRequest()
                {
                    Name = Site.Name,
                    Description = Site.Description,
                    // RoleId = Site.RoleId,
                    Urls = Site.Urls.ToArray()
                };
            try
            {
                await _httpClient.PostAsJsonAsync($"site/create", createCommand);
                _navigationManager.NavigateTo("/admin/sites");
            }
            catch (Exception)
            {

                throw;
            }
        }
        //Edit
        else
        {
            var updateCommand = new SiteUpdateRequest
                {
                    Id = Id.Value,
                    Name = Site.Name,
                    Description = Site.Description,
                    // RoleId = Site.RoleId,
                    Urls = Site.Urls.ToArray()
                };
            try
            {
                await _httpClient.PatchAsJsonAsync($"site/update", updateCommand);
                _navigationManager.NavigateTo("/admin/sites");
            }
            catch (Exception)
            {

                throw;
            }
        }
    }
}
